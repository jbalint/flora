#! /bin/sh

if [ -e binary-distribution.txt ]; then
    echo ""
    echo +++++ This seems to be a binary distribution of FLORA-2.
    echo +++++ Please use floraconfig to configure it:
    echo +++++   floraconfig path-for-/XSB/bin/xsb
    echo ""
    exit 1
fi

if [ "$1" = clean ] ; then
    make clean
    exit 0
fi

# if the very first param is --testing, compile in testing mode
if [ "$1" = "--testing" ] ; then
    touch flrincludes/flora_terms.flh
    if [ -r ../flora2-testsuite/flrtesthook.flh ]; then
	ln -s ../flora2-testsuite/flrtesthook.flh .
    fi
    shift
else
    /bin/rm -f flrtesthook.flh
fi

if [ -n "$1" -a "$1" != all -a "$1" != top -a "$1" != core -a "$1" != system -a "$1" != base -a "$1" != libs -a "$1" != misc -a "$1" != "-I" -a "$1" != "-S" ] ; then
    echo ""
    echo +++++ Argument 1 must be a Makefile target such as all, top, core, etc.
    echo ""
    exit 1
fi

# if the first argument is -S, use subsumptive tabling
# if the first argument is -I, use incremental tabling
tabling_method="/* default tabling */"
if test "$1" = "-S"; then
    tabling_method="#define FLORA_SUBSUMPTIVE_TABLING"
    shift
fi
if test "$1" = "-I"; then
    tabling_method="#define FLORA_INCREMENTAL_TABLING"
    shift
fi
if test "$1" = "-S"; then
    tabling_method="#define FLORA_SUBSUMPTIVE_TABLING"
    shift
fi

# Arg 1 is a make target. One of: all (default), system, base, top

if [ -z "$2" ] ; then
    prologcmd=none
else
    prologcmd=$2
fi

./floraconfig "$prologcmd" compiling || exit 1
# Set PROLOG to the absolute path that was generated by flrconfig.P
. ./.flora_paths

default_tabling=flrincludes/.flora_default_tabling
echo "$tabling_method" >  $default_tabling

chmod 755 ./runflora ./runflora*.bat

if [ -d /cygdrive/c  ]; then
    # It is CYGWIN
    rm -f cc/*.dll cc/*.lib cc/*.exp cc/*.obj cc/*.def cc/*.a cc/*.o
    rm -f cc/prolog2hilog.xwam
fi

cd cc
if [ -r hooks/flora_prefix.in ]; then
    cp hooks/flora_prefix.in ./flora_prefix.h
else
    cp flora_prefix.in flora_prefix.h
fi
cd ..

if [ "`basename $0`" = "makeergo" -a -d hooks ]; then
    touch hooks/ergo.switch flrincludes/flora_terms.flh flrincludes/flora_exceptions.flh
elif [ -d hooks ]; then
    touch flrincludes/flora_terms.flh flrincludes/flora_exceptions.flh
    /bin/rm -f hooks/ergo.switch
fi

# touch to update version display
touch flrversion.P flora2.P
make $1 PROLOG=$PROLOG


chmod a+r * */*

