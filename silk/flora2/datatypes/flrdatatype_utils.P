/* File:      flrdatatype_utils.P  -- Utils for data types
**
** Author(s): Michael Kifer
**
** Contact:   kifer@cs.stonybrook.edu
**
** Copyright (C) by
**      The Research Foundation of the State University of New York, 1999-2008.
**
** All rights reserved.
**
** For information about licensing terms, please see
** http://silk.projects.semwebcentral.org/flora2-license.html
**
**
*/


:- compiler_options([xpp_on]).
#include "flora_characters.flh"

:- import length/2, reverse/2 from basics.
:- import flora_concat_strings/2 from flrporting.

:- import flora_abort/1 from flrutils.

:- export
	flora_toLower/2,
	flora_toUpper/2,
	flora_startsWith_list/2,
	flora_second_repr/2,
	flora_cut_off_trailing_zeros/2,
	flora_int_to_atom_with_leading_zeros/3.

%% Convert Integer to atom and pad 0's in front up to the desired length
flora_int_to_atom_with_leading_zeros(Int,DesiredLength,Result) :-
	number_codes(Int,IntChars),
	length(IntChars,IntSize),
	PadNum is max(0, DesiredLength - IntSize),
	pad_with(IntChars,CH_0,PadNum,Result).


pad_with(IntChars,_CharCode,PadNum,IntChars) :- PadNum < 1, !.
pad_with(IntChars,CharCode,PadNum,Result) :-
	PadNum > 0,
	PaddedLst = [CharCode|IntChars],
	PadNum1 is PadNum - 1,
	pad_with(PaddedLst,CharCode,PadNum1,Result).

%% representation for seconds
flora_second_repr(Sec,Repr) :-
	atom(Sec),
	atom_codes(Sec,SecLst),
	(SecLst==[]
	-> Num = 0
	;
	    number_codes(Num,SecLst)
	),
	flora_second_repr(Num,Repr),
	!.
flora_second_repr(Sec,Repr) :-
	number(Sec),
	!,
	IntPart is truncate(Sec),
	Frac is Sec-IntPart,
	frac_repr(Frac,FracRepr),
	flora_int_to_atom_with_leading_zeros(IntPart,2,IntRepr),
	flora_concat_strings([IntRepr,FracRepr],Repr).
flora_second_repr(Sec,_Repr) :-
	flora_abort(['invalid specification for seconds, ', Sec]).

%% This is a bit dirty: just returns the 6 significant digits of the fraction
%% and rounds up the rest
frac_repr(Frac,FracRepr) :-
	Frac1 is round(Frac * 1000000),
	(Frac1 > 0
	-> number_codes(Frac1,Codes),
	    flora_cut_off_trailing_zeros(Codes,Codes1),
	    FracRepr = [CH_DOT|Codes1]
	;
	    FracRepr = ""
	).

flora_cut_off_trailing_zeros(Codes,Codes1) :-
	reverse(Codes,RCodes),
	cut_off_leading_zeros(RCodes,RCodes1),
	reverse(RCodes1,Codes1).
cut_off_leading_zeros([],[]) :- !.
cut_off_leading_zeros([CH_0|Rest],Result) :-
	!,
	cut_off_leading_zeros(Rest,Result).
cut_off_leading_zeros(Rest,Rest).



:- table flora_toLower/2.

flora_toLower(Atom,Result) :-
	atom_codes(Atom,ACodes),
	flora_toLower_list(ACodes,ACodesResult),
	atom_codes(Result,ACodesResult).

flora_toLower_list([],[]) :- !.
flora_toLower_list([C|CodeL],[C1|CodeLResult]) :-
	toLowerCode(C,C1),
	flora_toLower_list(CodeL,CodeLResult).

toLowerCode(C,C1) :-
	C >= CH_A, C =< CH_Z,
	!,
	C1 is C + (CH_a - CH_A).
toLowerCode(C,C).

:- table flora_toUpper/2.

flora_toUpper(Atom,Result) :-
	atom_codes(Atom,ACodes),
	flora_toUpper_list(ACodes,ACodesResult),
	atom_codes(Result,ACodesResult).

flora_toUpper_list([],[]) :- !.
flora_toUpper_list([C|CodeL],[C1|CodeLResult]) :-
	toUpperCode(C,C1),
	flora_toUpper_list(CodeL,CodeLResult).

toUpperCode(C,C1) :-
	C >= CH_a, C =< CH_z,
	!,
	C1 is C + (CH_A - CH_a).
toUpperCode(C,C).


flora_startsWith_list(_List,[]) :- !.
flora_startsWith_list([H|RestList],[H|RestSubList]) :-
	flora_startsWith_list(RestList,RestSubList).

