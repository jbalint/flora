#! /bin/sh

# if the first argument is -S, use subsumptive tabling
# if the first argument is -I, use incremental tabling
current_tabling=flrincludes/.flora_current_tabling
echo "" > $current_tabling
if test "$1" = "-S"; then
    echo "#define FLORA_SUBSUMPTIVE_TABLING" > $current_tabling
    shift
fi
if test "$1" = "-I"; then
    echo "#define FLORA_INCREMENTAL_TABLING" > $current_tabling
    shift
fi
if test "$1" = "-S"; then
    echo "#define FLORA_SUBSUMPTIVE_TABLING" > $current_tabling
    shift
fi

# Arg 1 is a make target. One of: all (default), system, base, top

# If arg 2, use it as path to prolog. Otherwise, assume xsb is on PATH
if test "$2" = "" ; then
   PROLOG=xsb
else
   PROLOG=$2
fi

# Generate the files that contain the Prolog & Flora installation directories
# Generates runflora file that can be used to run flora
rm -fr .makeflora.tmp
(echo "['flrdepstest.P']." | $PROLOG) \
    || (echo "++Please reconfigure or reinstall XSB.";  touch .makeflora.tmp)
if test -f .makeflora.tmp ; then
    rm -rf .makeflora.tmp
    exit 1
fi

(echo "['flrconfig.P']." | $PROLOG) \
    || (echo "Usage:  makeflora all full-path-to-prolog"; touch .makeflora.tmp)
if test -f .makeflora.tmp ; then
    rm -rf .makeflora.tmp
    exit 1
fi

chmod 755 ./runflora

# Set PROLOG to the absolute path that was generated by flrconfig.P
if [ -d c:\  ]; then
    # It is CYGWIN
    PROLOG=`cat .prolog_path_cygwin`/xsb
    rm -f p2h/*.dll p2h/*.lib p2h/*.exp p2h/*.obj p2h/*.def p2h/*.a p2h/*.o
    rm -f p2h/prolog2hilog.xwam
else
    PROLOG=`cat .prolog_path`/xsb
fi

if [ ! -e binary-distribution.txt ]; then
    make $1 PROLOG=$PROLOG
fi

chmod a+r * */*

