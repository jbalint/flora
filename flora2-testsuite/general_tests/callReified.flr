
?- [callReified_foo>>foo, callReified_foo2>>foo2].

a(a).
p(?Y) :- a(?Y), caller{?C}, writeln(caller=?C)@_plg().

%p(?Y) :- a(?Y), caller{?C}, writeln('%caller'=?C)@_plg().

pp(a) :- caller{?X},
	if var(?X) then ?X = '*a variable*',
        (write(caller=?X), write(' '))@_plg().

c[b->?_Y] :- caller{?X}, write(caller1=?X)@_plg().

?- insertrule{(a[b->?Y] :- a(?Y), caller{?X}, write(caller=?X)@_plg())}.

?- ?Z = ${b[b->?_Y] :- caller{?X}, write(caller1=?X)@_plg()},
	insert{?Z}.
?- ?Z = ${(b[b->?Y] :- caller{?X}, (write(caller2=?X), write(' '))@_plg(), b[b->?Y]@main)@foo},
	insert{?Z}.

%test1 :- write('test1: ')@_plg(),
	  ?X = ${p(?_Y)},
	  f(?X)@foo, abolish_all_tables.
%test2 :- write('test2: ')@_plg(),
	  ?X ~ p(?_Y),
	  f(?X)@foo, abolish_all_tables.

%test3 :- write('test3: ')@_plg(),
	  ?X = ${%p(?_Y)},
	  f(?X)@foo, abolish_all_tables.
%test4 :- write('test4: ')@_plg(),
	  ?X ~ %p(?_Y),
	  f(?X)@foo, abolish_all_tables.

%test5 :- write('test5: ')@_plg(),
	?X ~ pp(a), 
	qq(?X)@foo, qq(?Y)@foo2,
	?X ~ ?Y,
	writeln(' done')@_plg(),
	abolish_all_tables.

%test6 :- write('test6: ')@_plg(),
	a[b->?X]@foo,
	(flora_write_goal(?X)@_plg(flrdecode), write(' '))@_plg(),
	a[b->?Y], (write(' '), writeln(?Y))@_plg(),
	abolish_all_tables.

%test7 :- write('test7: ')@_plg(),
	?X ~ a[b-> ${ppp(a)@foo}]@foo, ?X,  writeln(' done')@_plg(),
	abolish_all_tables.

// should be: caller2 = main caller1 = foo
%test8 :- write('test8: ')@_plg(),
	b[b->?_X]@foo,
	writeln(' done')@_plg(),
	abolish_all_tables.

// should be: caller2 = main caller1 = foo
%test9 :- write('test9: ')@_plg(),
	c[b->?_X]@foo,
	writeln(' done')@_plg(),
	abolish_all_tables.

%pretest :- %test1, %test2 and %test3 and %test4,
	    %test5, %test6, %test7, %test8, %test9.

%test :- tell(temp)@_plg(),
	Method[mustDefine(on)]@_sys,
	%pretest,
	Method[mustDefine(off)]@_sys,
	%pretest,
	told@_plg().


